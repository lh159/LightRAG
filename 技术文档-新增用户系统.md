# LightRAGæ ‡ç­¾ç³»ç»Ÿ - ç”¨æˆ·ç³»ç»Ÿé›†æˆæ–¹æ¡ˆ

## ğŸ¯ é¡¹ç›®æ¦‚è¿°

åŸºäºç°æœ‰LightRAGæ ‡ç­¾ç³»ç»Ÿï¼Œé›†æˆå®Œæ•´çš„ç”¨æˆ·ç®¡ç†ç³»ç»Ÿï¼Œå®ç°å¤šç”¨æˆ·éš”ç¦»ã€ç”¨æˆ·è®¤è¯ã€æƒé™ç®¡ç†å’Œæ•°æ®å®‰å…¨ã€‚

**æ ¸å¿ƒç›®æ ‡**ï¼š
- å¤šç”¨æˆ·éš”ç¦»ä¸æ•°æ®å®‰å…¨
- ç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€æƒé™ç®¡ç†
- ç”¨æˆ·ç”»åƒæŒä¹…åŒ–å­˜å‚¨
- ä¼šè¯ç®¡ç†ä¸çŠ¶æ€ä¿æŒ
- ç”¨æˆ·æ•°æ®å¤‡ä»½ä¸æ¢å¤

---

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„è®¾è®¡

### å½“å‰æ¶æ„åˆ†æ
```
LightRAG-TagSystem-Demo/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ core/                   # æ ¸å¿ƒæ¨¡å—ï¼ˆå·²å­˜åœ¨ï¼‰
â”‚   â”‚   â”œâ”€â”€ lightrag_engine.py  # LightRAGå¼•æ“
â”‚   â”‚   â”œâ”€â”€ tag_extractor.py    # æ ‡ç­¾æå–å™¨
â”‚   â”‚   â”œâ”€â”€ tag_manager.py      # æ ‡ç­¾ç®¡ç†å™¨
â”‚   â”‚   â””â”€â”€ response_generator.py # å›åº”ç”Ÿæˆå™¨
â”‚   â””â”€â”€ utils/                  # å·¥å…·å‡½æ•°
â”‚       â””â”€â”€ llm_client.py       # LLMå®¢æˆ·ç«¯
â”œâ”€â”€ web/                        # Webåº”ç”¨
â”‚   â”œâ”€â”€ app.py                  # Flaskåº”ç”¨
â”‚   â””â”€â”€ templates/              # å‰ç«¯æ¨¡æ¿
â”œâ”€â”€ user_data/                  # ç”¨æˆ·æ•°æ®ï¼ˆå½“å‰åŸºäºsessionï¼‰
â””â”€â”€ config.yaml                 # é…ç½®æ–‡ä»¶
```

### ç›®æ ‡æ¶æ„è®¾è®¡
```
LightRAG-TagSystem-Demo/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ core/                   # æ ¸å¿ƒæ¨¡å—
â”‚   â”‚   â”œâ”€â”€ lightrag_engine.py  # LightRAGå¼•æ“
â”‚   â”‚   â”œâ”€â”€ tag_extractor.py    # æ ‡ç­¾æå–å™¨
â”‚   â”‚   â”œâ”€â”€ tag_manager.py      # æ ‡ç­¾ç®¡ç†å™¨
â”‚   â”‚   â”œâ”€â”€ response_generator.py # å›åº”ç”Ÿæˆå™¨
â”‚   â”‚   â””â”€â”€ user_manager.py     # ğŸ†• ç”¨æˆ·ç®¡ç†å™¨
â”‚   â”œâ”€â”€ models/                 # ğŸ†• æ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ user_model.py       # ç”¨æˆ·æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ session_model.py    # ä¼šè¯æ¨¡å‹
â”‚   â”‚   â””â”€â”€ permission_model.py # æƒé™æ¨¡å‹
â”‚   â”œâ”€â”€ auth/                   # ğŸ†• è®¤è¯æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ auth_manager.py     # è®¤è¯ç®¡ç†å™¨
â”‚   â”‚   â”œâ”€â”€ password_utils.py   # å¯†ç å·¥å…·
â”‚   â”‚   â””â”€â”€ jwt_utils.py        # JWTå·¥å…·
â”‚   â”œâ”€â”€ api/                    # ğŸ†• APIæ¥å£
â”‚   â”‚   â”œâ”€â”€ auth_api.py         # è®¤è¯API
â”‚   â”‚   â”œâ”€â”€ user_api.py         # ç”¨æˆ·API
â”‚   â”‚   â””â”€â”€ admin_api.py        # ç®¡ç†API
â”‚   â””â”€â”€ utils/                  # å·¥å…·å‡½æ•°
â”‚       â”œâ”€â”€ llm_client.py       # LLMå®¢æˆ·ç«¯
â”‚       â”œâ”€â”€ database.py         # ğŸ†• æ•°æ®åº“å·¥å…·
â”‚       â””â”€â”€ security.py         # ğŸ†• å®‰å…¨å·¥å…·
â”œâ”€â”€ web/
â”‚   â”œâ”€â”€ app.py                  # ä¸»åº”ç”¨
â”‚   â”œâ”€â”€ templates/              # å‰ç«¯æ¨¡æ¿
â”‚   â”‚   â”œâ”€â”€ index.html          # ä¸»é¡µ
â”‚   â”‚   â”œâ”€â”€ login.html          # ğŸ†• ç™»å½•é¡µ
â”‚   â”‚   â”œâ”€â”€ register.html       # ğŸ†• æ³¨å†Œé¡µ
â”‚   â”‚   â””â”€â”€ profile.html        # ğŸ†• ç”¨æˆ·èµ„æ–™é¡µ
â”‚   â””â”€â”€ static/                 # ğŸ†• é™æ€èµ„æº
â”‚       â”œâ”€â”€ css/
â”‚       â”œâ”€â”€ js/
â”‚       â””â”€â”€ images/
â”œâ”€â”€ database/                   # ğŸ†• æ•°æ®åº“
â”‚   â”œâ”€â”€ users.db               # SQLiteç”¨æˆ·æ•°æ®åº“
â”‚   â””â”€â”€ migrations/            # æ•°æ®åº“è¿ç§»
â”œâ”€â”€ user_data/                  # ç”¨æˆ·æ•°æ®ç›®å½•
â”‚   â”œâ”€â”€ user_123/              # ç”¨æˆ·æ•°æ®æ–‡ä»¶å¤¹
â”‚   â””â”€â”€ global/                # å…¨å±€é…ç½®
â””â”€â”€ config.yaml                 # é…ç½®æ–‡ä»¶
```

---

## ğŸ“‹ å®æ–½æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šæ•°æ®åº“è®¾è®¡ä¸ç”¨æˆ·æ¨¡å‹

#### 1.1 åˆ›å»ºæ•°æ®åº“å·¥å…· (app/utils/database.py)

```python
import sqlite3
import os
import json
from datetime import datetime
from typing import Dict, List, Optional
import hashlib
import secrets

class DatabaseManager:
    def __init__(self, db_path: str = "database/users.db"):
        self.db_path = db_path
        self.ensure_database_directory()
        self.init_database()
    
    def ensure_database_directory(self):
        """ç¡®ä¿æ•°æ®åº“ç›®å½•å­˜åœ¨"""
        os.makedirs(os.path.dirname(self.db_path), exist_ok=True)
    
    def init_database(self):
        """åˆå§‹åŒ–æ•°æ®åº“è¡¨"""
        with sqlite3.connect(self.db_path) as conn:
            cursor = conn.cursor()
            
            # ç”¨æˆ·è¡¨
            cursor.execute('''
                CREATE TABLE IF NOT EXISTS users (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    username VARCHAR(50) UNIQUE NOT NULL,
                    email VARCHAR(100) UNIQUE,
                    password_hash VARCHAR(255) NOT NULL,
                    salt VARCHAR(255) NOT NULL,
                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    last_login TIMESTAMP,
                    is_active BOOLEAN DEFAULT 1,
                    is_admin BOOLEAN DEFAULT 0,
                    profile_data TEXT,
                    settings TEXT
                )
            ''')
            
            # ä¼šè¯è¡¨
            cursor.execute('''
                CREATE TABLE IF NOT EXISTS sessions (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    user_id INTEGER NOT NULL,
                    session_token VARCHAR(255) UNIQUE NOT NULL,
                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    expires_at TIMESTAMP NOT NULL,
                    is_active BOOLEAN DEFAULT 1,
                    FOREIGN KEY (user_id) REFERENCES users (id)
                )
            ''')
            
            # ç”¨æˆ·æ ‡ç­¾è¡¨
            cursor.execute('''
                CREATE TABLE IF NOT EXISTS user_tags (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    user_id INTEGER NOT NULL,
                    dimension VARCHAR(50) NOT NULL,
                    tag_name VARCHAR(100) NOT NULL,
                    confidence REAL DEFAULT 0.5,
                    evidence TEXT,
                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    last_updated TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    is_active BOOLEAN DEFAULT 1,
                    FOREIGN KEY (user_id) REFERENCES users (id)
                )
            ''')
            
            # ç”¨æˆ·çŸ¥è¯†åº“è¡¨
            cursor.execute('''
                CREATE TABLE IF NOT EXISTS user_knowledge (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    user_id INTEGER NOT NULL,
                    content TEXT NOT NULL,
                    metadata TEXT,
                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    last_accessed TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    access_count INTEGER DEFAULT 0,
                    FOREIGN KEY (user_id) REFERENCES users (id)
                )
            ''')
            
            conn.commit()
    
    def create_user(self, username: str, password: str, email: str = None) -> Dict:
        """åˆ›å»ºæ–°ç”¨æˆ·"""
        try:
            salt = secrets.token_hex(16)
            password_hash = self._hash_password(password, salt)
            
            with sqlite3.connect(self.db_path) as conn:
                cursor = conn.cursor()
                cursor.execute('''
                    INSERT INTO users (username, email, password_hash, salt)
                    VALUES (?, ?, ?, ?)
                ''', (username, email, password_hash, salt))
                
                user_id = cursor.lastrowid
                conn.commit()
                
                return {
                    "success": True,
                    "user_id": user_id,
                    "username": username
                }
        except sqlite3.IntegrityError:
            return {
                "success": False,
                "error": "ç”¨æˆ·åæˆ–é‚®ç®±å·²å­˜åœ¨"
            }
        except Exception as e:
            return {
                "success": False,
                "error": f"åˆ›å»ºç”¨æˆ·å¤±è´¥: {str(e)}"
            }
    
    def authenticate_user(self, username: str, password: str) -> Dict:
        """ç”¨æˆ·è®¤è¯"""
        try:
            with sqlite3.connect(self.db_path) as conn:
                cursor = conn.cursor()
                cursor.execute('''
                    SELECT id, username, password_hash, salt, is_active
                    FROM users WHERE username = ?
                ''', (username,))
                
                result = cursor.fetchone()
                if not result:
                    return {"success": False, "error": "ç”¨æˆ·ä¸å­˜åœ¨"}
                
                user_id, username, stored_hash, salt, is_active = result
                
                if not is_active:
                    return {"success": False, "error": "è´¦æˆ·å·²è¢«ç¦ç”¨"}
                
                # éªŒè¯å¯†ç 
                input_hash = self._hash_password(password, salt)
                if input_hash != stored_hash:
                    return {"success": False, "error": "å¯†ç é”™è¯¯"}
                
                # æ›´æ–°æœ€åç™»å½•æ—¶é—´
                cursor.execute('''
                    UPDATE users SET last_login = CURRENT_TIMESTAMP
                    WHERE id = ?
                ''', (user_id,))
                conn.commit()
                
                return {
                    "success": True,
                    "user_id": user_id,
                    "username": username
                }
        except Exception as e:
            return {
                "success": False,
                "error": f"è®¤è¯å¤±è´¥: {str(e)}"
            }
    
    def create_session(self, user_id: int, expires_hours: int = 24) -> str:
        """åˆ›å»ºç”¨æˆ·ä¼šè¯"""
        session_token = secrets.token_hex(32)
        expires_at = datetime.now().timestamp() + (expires_hours * 3600)
        
        with sqlite3.connect(self.db_path) as conn:
            cursor = conn.cursor()
            cursor.execute('''
                INSERT INTO sessions (user_id, session_token, expires_at)
                VALUES (?, ?, datetime(?, 'unixepoch'))
            ''', (user_id, session_token, expires_at))
            conn.commit()
        
        return session_token
    
    def validate_session(self, session_token: str) -> Optional[int]:
        """éªŒè¯ä¼šè¯å¹¶è¿”å›ç”¨æˆ·ID"""
        try:
            with sqlite3.connect(self.db_path) as conn:
                cursor = conn.cursor()
                cursor.execute('''
                    SELECT user_id FROM sessions 
                    WHERE session_token = ? 
                    AND expires_at > CURRENT_TIMESTAMP
                    AND is_active = 1
                ''', (session_token,))
                
                result = cursor.fetchone()
                return result[0] if result else None
        except Exception:
            return None
    
    def _hash_password(self, password: str, salt: str) -> str:
        """å¯†ç å“ˆå¸Œ"""
        return hashlib.sha256((password + salt).encode()).hexdigest()
```

#### 1.2 åˆ›å»ºç”¨æˆ·æ¨¡å‹ (app/models/user_model.py)

```python
from dataclasses import dataclass
from datetime import datetime
from typing import Dict, List, Optional
import json

@dataclass
class User:
    id: int
    username: str
    email: Optional[str]
    created_at: datetime
    last_login: Optional[datetime]
    is_active: bool
    is_admin: bool
    profile_data: Dict
    settings: Dict

@dataclass
class UserSession:
    id: int
    user_id: int
    session_token: str
    created_at: datetime
    expires_at: datetime
    is_active: bool

@dataclass
class UserTag:
    id: int
    user_id: int
    dimension: str
    tag_name: str
    confidence: float
    evidence: str
    created_at: datetime
    last_updated: datetime
    is_active: bool

class UserManager:
    def __init__(self, db_manager):
        self.db_manager = db_manager
    
    def get_user_by_id(self, user_id: int) -> Optional[User]:
        """æ ¹æ®IDè·å–ç”¨æˆ·"""
        try:
            with self.db_manager.get_connection() as conn:
                cursor = conn.cursor()
                cursor.execute('''
                    SELECT id, username, email, created_at, last_login, 
                           is_active, is_admin, profile_data, settings
                    FROM users WHERE id = ?
                ''', (user_id,))
                
                result = cursor.fetchone()
                if not result:
                    return None
                
                return User(
                    id=result[0],
                    username=result[1],
                    email=result[2],
                    created_at=datetime.fromisoformat(result[3]),
                    last_login=datetime.fromisoformat(result[4]) if result[4] else None,
                    is_active=bool(result[5]),
                    is_admin=bool(result[6]),
                    profile_data=json.loads(result[7]) if result[7] else {},
                    settings=json.loads(result[8]) if result[8] else {}
                )
        except Exception as e:
            print(f"è·å–ç”¨æˆ·å¤±è´¥: {e}")
            return None
    
    def update_user_profile(self, user_id: int, profile_data: Dict) -> bool:
        """æ›´æ–°ç”¨æˆ·èµ„æ–™"""
        try:
            with self.db_manager.get_connection() as conn:
                cursor = conn.cursor()
                cursor.execute('''
                    UPDATE users SET profile_data = ?
                    WHERE id = ?
                ''', (json.dumps(profile_data), user_id))
                conn.commit()
                return True
        except Exception as e:
            print(f"æ›´æ–°ç”¨æˆ·èµ„æ–™å¤±è´¥: {e}")
            return False
    
    def get_user_tags(self, user_id: int) -> List[UserTag]:
        """è·å–ç”¨æˆ·æ ‡ç­¾"""
        try:
            with self.db_manager.get_connection() as conn:
                cursor = conn.cursor()
                cursor.execute('''
                    SELECT id, user_id, dimension, tag_name, confidence,
                           evidence, created_at, last_updated, is_active
                    FROM user_tags WHERE user_id = ? AND is_active = 1
                    ORDER BY dimension, confidence DESC
                ''', (user_id,))
                
                results = cursor.fetchall()
                return [
                    UserTag(
                        id=row[0], user_id=row[1], dimension=row[2],
                        tag_name=row[3], confidence=row[4], evidence=row[5],
                        created_at=datetime.fromisoformat(row[6]),
                        last_updated=datetime.fromisoformat(row[7]),
                        is_active=bool(row[8])
                    )
                    for row in results
                ]
        except Exception as e:
            print(f"è·å–ç”¨æˆ·æ ‡ç­¾å¤±è´¥: {e}")
            return []
```

### ç¬¬äºŒæ­¥ï¼šè®¤è¯ç³»ç»Ÿå®ç°

#### 2.1 åˆ›å»ºè®¤è¯ç®¡ç†å™¨ (app/auth/auth_manager.py)

```python
import jwt
import secrets
from datetime import datetime, timedelta
from typing import Optional, Dict
from flask import request, session

class AuthManager:
    def __init__(self, db_manager, secret_key: str):
        self.db_manager = db_manager
        self.secret_key = secret_key
    
    def login(self, username: str, password: str) -> Dict:
        """ç”¨æˆ·ç™»å½•"""
        # éªŒè¯ç”¨æˆ·å‡­æ®
        auth_result = self.db_manager.authenticate_user(username, password)
        
        if not auth_result["success"]:
            return auth_result
        
        user_id = auth_result["user_id"]
        
        # åˆ›å»ºä¼šè¯
        session_token = self.db_manager.create_session(user_id)
        
        # ç”ŸæˆJWTä»¤ç‰Œ
        jwt_token = self._generate_jwt_token(user_id, username)
        
        return {
            "success": True,
            "user_id": user_id,
            "username": username,
            "session_token": session_token,
            "jwt_token": jwt_token
        }
    
    def register(self, username: str, password: str, email: str = None) -> Dict:
        """ç”¨æˆ·æ³¨å†Œ"""
        # éªŒè¯è¾“å…¥
        validation_result = self._validate_registration_input(username, password, email)
        if not validation_result["success"]:
            return validation_result
        
        # åˆ›å»ºç”¨æˆ·
        create_result = self.db_manager.create_user(username, password, email)
        
        if create_result["success"]:
            # è‡ªåŠ¨ç™»å½•
            return self.login(username, password)
        else:
            return create_result
    
    def logout(self, session_token: str) -> bool:
        """ç”¨æˆ·ç™»å‡º"""
        try:
            with self.db_manager.get_connection() as conn:
                cursor = conn.cursor()
                cursor.execute('''
                    UPDATE sessions SET is_active = 0
                    WHERE session_token = ?
                ''', (session_token,))
                conn.commit()
                return True
        except Exception:
            return False
    
    def validate_token(self, token: str) -> Optional[Dict]:
        """éªŒè¯JWTä»¤ç‰Œ"""
        try:
            payload = jwt.decode(token, self.secret_key, algorithms=["HS256"])
            user_id = payload.get("user_id")
            username = payload.get("username")
            exp = payload.get("exp")
            
            if not user_id or not username or not exp:
                return None
            
            # æ£€æŸ¥ä»¤ç‰Œæ˜¯å¦è¿‡æœŸ
            if datetime.utcnow().timestamp() > exp:
                return None
            
            return {
                "user_id": user_id,
                "username": username
            }
        except jwt.InvalidTokenError:
            return None
    
    def get_current_user(self) -> Optional[Dict]:
        """è·å–å½“å‰ç”¨æˆ·"""
        # ä»è¯·æ±‚å¤´è·å–ä»¤ç‰Œ
        auth_header = request.headers.get("Authorization")
        if auth_header and auth_header.startswith("Bearer "):
            token = auth_header[7:]
            return self.validate_token(token)
        
        # ä»sessionè·å–
        if "user_id" in session:
            user_id = session["user_id"]
            user = self.db_manager.get_user_by_id(user_id)
            if user:
                return {
                    "user_id": user.id,
                    "username": user.username
                }
        
        return None
    
    def _generate_jwt_token(self, user_id: int, username: str) -> str:
        """ç”ŸæˆJWTä»¤ç‰Œ"""
        payload = {
            "user_id": user_id,
            "username": username,
            "exp": datetime.utcnow() + timedelta(hours=24),
            "iat": datetime.utcnow()
        }
        return jwt.encode(payload, self.secret_key, algorithm="HS256")
    
    def _validate_registration_input(self, username: str, password: str, email: str = None) -> Dict:
        """éªŒè¯æ³¨å†Œè¾“å…¥"""
        if not username or len(username) < 3:
            return {"success": False, "error": "ç”¨æˆ·åè‡³å°‘éœ€è¦3ä¸ªå­—ç¬¦"}
        
        if not password or len(password) < 6:
            return {"success": False, "error": "å¯†ç è‡³å°‘éœ€è¦6ä¸ªå­—ç¬¦"}
        
        if email and "@" not in email:
            return {"success": False, "error": "é‚®ç®±æ ¼å¼ä¸æ­£ç¡®"}
        
        return {"success": True}
```

#### 2.2 åˆ›å»ºè®¤è¯è£…é¥°å™¨ (app/auth/decorators.py)

```python
from functools import wraps
from flask import request, jsonify, session
from app.auth.auth_manager import AuthManager

def login_required(f):
    """ç™»å½•å¿…éœ€è£…é¥°å™¨"""
    @wraps(f)
    def decorated_function(*args, **kwargs):
        auth_manager = AuthManager(request.app.config['DB_MANAGER'], 
                                 request.app.config['SECRET_KEY'])
        
        current_user = auth_manager.get_current_user()
        if not current_user:
            return jsonify({
                "success": False,
                "error": "éœ€è¦ç™»å½•"
            }), 401
        
        # å°†ç”¨æˆ·ä¿¡æ¯æ·»åŠ åˆ°è¯·æ±‚ä¸Šä¸‹æ–‡
        request.current_user = current_user
        return f(*args, **kwargs)
    
    return decorated_function

def admin_required(f):
    """ç®¡ç†å‘˜æƒé™è£…é¥°å™¨"""
    @wraps(f)
    def decorated_function(*args, **kwargs):
        auth_manager = AuthManager(request.app.config['DB_MANAGER'], 
                                 request.app.config['SECRET_KEY'])
        
        current_user = auth_manager.get_current_user()
        if not current_user:
            return jsonify({
                "success": False,
                "error": "éœ€è¦ç™»å½•"
            }), 401
        
        # æ£€æŸ¥ç®¡ç†å‘˜æƒé™
        user = auth_manager.db_manager.get_user_by_id(current_user["user_id"])
        if not user or not user.is_admin:
            return jsonify({
                "success": False,
                "error": "éœ€è¦ç®¡ç†å‘˜æƒé™"
            }), 403
        
        request.current_user = current_user
        return f(*args, **kwargs)
    
    return decorated_function
```

### ç¬¬ä¸‰æ­¥ï¼šAPIæ¥å£å®ç°

#### 3.1 è®¤è¯API (app/api/auth_api.py)

```python
from flask import Blueprint, request, jsonify, session
from app.auth.auth_manager import AuthManager

auth_bp = Blueprint('auth', __name__)

@auth_bp.route('/register', methods=['POST'])
def register():
    """ç”¨æˆ·æ³¨å†Œ"""
    try:
        data = request.json
        username = data.get('username', '').strip()
        password = data.get('password', '')
        email = data.get('email', '').strip()
        
        auth_manager = AuthManager(
            request.app.config['DB_MANAGER'],
            request.app.config['SECRET_KEY']
        )
        
        result = auth_manager.register(username, password, email)
        
        if result["success"]:
            # è®¾ç½®session
            session['user_id'] = result["user_id"]
            session['username'] = result["username"]
            
            return jsonify({
                "success": True,
                "message": "æ³¨å†ŒæˆåŠŸ",
                "user": {
                    "id": result["user_id"],
                    "username": result["username"]
                },
                "token": result["jwt_token"]
            })
        else:
            return jsonify(result), 400
            
    except Exception as e:
        return jsonify({
            "success": False,
            "error": f"æ³¨å†Œå¤±è´¥: {str(e)}"
        }), 500

@auth_bp.route('/login', methods=['POST'])
def login():
    """ç”¨æˆ·ç™»å½•"""
    try:
        data = request.json
        username = data.get('username', '').strip()
        password = data.get('password', '')
        
        auth_manager = AuthManager(
            request.app.config['DB_MANAGER'],
            request.app.config['SECRET_KEY']
        )
        
        result = auth_manager.login(username, password)
        
        if result["success"]:
            # è®¾ç½®session
            session['user_id'] = result["user_id"]
            session['username'] = result["username"]
            
            return jsonify({
                "success": True,
                "message": "ç™»å½•æˆåŠŸ",
                "user": {
                    "id": result["user_id"],
                    "username": result["username"]
                },
                "token": result["jwt_token"]
            })
        else:
            return jsonify(result), 401
            
    except Exception as e:
        return jsonify({
            "success": False,
            "error": f"ç™»å½•å¤±è´¥: {str(e)}"
        }), 500

@auth_bp.route('/logout', methods=['POST'])
def logout():
    """ç”¨æˆ·ç™»å‡º"""
    try:
        auth_manager = AuthManager(
            request.app.config['DB_MANAGER'],
            request.app.config['SECRET_KEY']
        )
        
        # æ¸…é™¤session
        session.clear()
        
        # å¦‚æœæœ‰tokenï¼Œä¹Ÿæ¸…é™¤ä¼šè¯
        auth_header = request.headers.get("Authorization")
        if auth_header and auth_header.startswith("Bearer "):
            token = auth_header[7:]
            # è¿™é‡Œå¯ä»¥æ·»åŠ tokené»‘åå•é€»è¾‘
        
        return jsonify({
            "success": True,
            "message": "ç™»å‡ºæˆåŠŸ"
        })
        
    except Exception as e:
        return jsonify({
            "success": False,
            "error": f"ç™»å‡ºå¤±è´¥: {str(e)}"
        }), 500

@auth_bp.route('/profile', methods=['GET'])
def get_profile():
    """è·å–ç”¨æˆ·èµ„æ–™"""
    try:
        auth_manager = AuthManager(
            request.app.config['DB_MANAGER'],
            request.app.config['SECRET_KEY']
        )
        
        current_user = auth_manager.get_current_user()
        if not current_user:
            return jsonify({
                "success": False,
                "error": "éœ€è¦ç™»å½•"
            }), 401
        
        user = auth_manager.db_manager.get_user_by_id(current_user["user_id"])
        
        return jsonify({
            "success": True,
            "user": {
                "id": user.id,
                "username": user.username,
                "email": user.email,
                "created_at": user.created_at.isoformat(),
                "last_login": user.last_login.isoformat() if user.last_login else None,
                "is_admin": user.is_admin,
                "profile_data": user.profile_data,
                "settings": user.settings
            }
        })
        
    except Exception as e:
        return jsonify({
            "success": False,
            "error": f"è·å–èµ„æ–™å¤±è´¥: {str(e)}"
        }), 500
```

#### 3.2 ç”¨æˆ·API (app/api/user_api.py)

```python
from flask import Blueprint, request, jsonify
from app.auth.decorators import login_required
from app.models.user_model import UserManager

user_bp = Blueprint('user', __name__)

@user_bp.route('/profile', methods=['PUT'])
@login_required
def update_profile():
    """æ›´æ–°ç”¨æˆ·èµ„æ–™"""
    try:
        data = request.json
        user_id = request.current_user["user_id"]
        
        user_manager = UserManager(request.app.config['DB_MANAGER'])
        
        # æ›´æ–°èµ„æ–™
        profile_data = data.get('profile_data', {})
        success = user_manager.update_user_profile(user_id, profile_data)
        
        if success:
            return jsonify({
                "success": True,
                "message": "èµ„æ–™æ›´æ–°æˆåŠŸ"
            })
        else:
            return jsonify({
                "success": False,
                "error": "èµ„æ–™æ›´æ–°å¤±è´¥"
            }), 500
            
    except Exception as e:
        return jsonify({
            "success": False,
            "error": f"æ›´æ–°èµ„æ–™å¤±è´¥: {str(e)}"
        }), 500

@user_bp.route('/tags', methods=['GET'])
@login_required
def get_user_tags():
    """è·å–ç”¨æˆ·æ ‡ç­¾"""
    try:
        user_id = request.current_user["user_id"]
        user_manager = UserManager(request.app.config['DB_MANAGER'])
        
        tags = user_manager.get_user_tags(user_id)
        
        # æŒ‰ç»´åº¦åˆ†ç»„
        tags_by_dimension = {}
        for tag in tags:
            if tag.dimension not in tags_by_dimension:
                tags_by_dimension[tag.dimension] = []
            tags_by_dimension[tag.dimension].append({
                "id": tag.id,
                "tag_name": tag.tag_name,
                "confidence": tag.confidence,
                "evidence": tag.evidence,
                "created_at": tag.created_at.isoformat(),
                "last_updated": tag.last_updated.isoformat()
            })
        
        return jsonify({
            "success": True,
            "tags": tags_by_dimension
        })
        
    except Exception as e:
        return jsonify({
            "success": False,
            "error": f"è·å–æ ‡ç­¾å¤±è´¥: {str(e)}"
        }), 500

@user_bp.route('/data/export', methods=['GET'])
@login_required
def export_user_data():
    """å¯¼å‡ºç”¨æˆ·æ•°æ®"""
    try:
        user_id = request.current_user["user_id"]
        user_manager = UserManager(request.app.config['DB_MANAGER'])
        
        # è·å–ç”¨æˆ·ä¿¡æ¯
        user = user_manager.get_user_by_id(user_id)
        tags = user_manager.get_user_tags(user_id)
        
        # è·å–ç”¨æˆ·çŸ¥è¯†åº“æ•°æ®
        knowledge_data = user_manager.get_user_knowledge(user_id)
        
        export_data = {
            "user_info": {
                "id": user.id,
                "username": user.username,
                "email": user.email,
                "created_at": user.created_at.isoformat(),
                "last_login": user.last_login.isoformat() if user.last_login else None
            },
            "tags": [{
                "dimension": tag.dimension,
                "tag_name": tag.tag_name,
                "confidence": tag.confidence,
                "evidence": tag.evidence,
                "created_at": tag.created_at.isoformat()
            } for tag in tags],
            "knowledge": knowledge_data,
            "export_date": datetime.now().isoformat()
        }
        
        return jsonify({
            "success": True,
            "data": export_data
        })
        
    except Exception as e:
        return jsonify({
            "success": False,
            "error": f"å¯¼å‡ºæ•°æ®å¤±è´¥: {str(e)}"
        }), 500
```

### ç¬¬å››æ­¥ï¼šå‰ç«¯ç•Œé¢å®ç°

#### 4.1 ç™»å½•é¡µé¢ (web/templates/login.html)

```html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™»å½• - LightRAGæ ‡ç­¾ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/auth.css') }}">
</head>
<body>
    <div class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <h1>LightRAGæ ‡ç­¾ç³»ç»Ÿ</h1>
                <p>æ™ºèƒ½æƒ…æ„Ÿé™ªä¼´åŠ©æ‰‹</p>
            </div>
            
            <div class="auth-tabs">
                <button class="tab-btn active" onclick="switchTab('login')">ç™»å½•</button>
                <button class="tab-btn" onclick="switchTab('register')">æ³¨å†Œ</button>
            </div>
            
            <!-- ç™»å½•è¡¨å• -->
            <form id="loginForm" class="auth-form">
                <div class="form-group">
                    <label for="loginUsername">ç”¨æˆ·å</label>
                    <input type="text" id="loginUsername" name="username" required>
                </div>
                
                <div class="form-group">
                    <label for="loginPassword">å¯†ç </label>
                    <input type="password" id="loginPassword" name="password" required>
                </div>
                
                <button type="submit" class="auth-btn">ç™»å½•</button>
            </form>
            
            <!-- æ³¨å†Œè¡¨å• -->
            <form id="registerForm" class="auth-form" style="display: none;">
                <div class="form-group">
                    <label for="registerUsername">ç”¨æˆ·å</label>
                    <input type="text" id="registerUsername" name="username" required>
                </div>
                
                <div class="form-group">
                    <label for="registerEmail">é‚®ç®±ï¼ˆå¯é€‰ï¼‰</label>
                    <input type="email" id="registerEmail" name="email">
                </div>
                
                <div class="form-group">
                    <label for="registerPassword">å¯†ç </label>
                    <input type="password" id="registerPassword" name="password" required>
                </div>
                
                <div class="form-group">
                    <label for="confirmPassword">ç¡®è®¤å¯†ç </label>
                    <input type="password" id="confirmPassword" name="confirmPassword" required>
                </div>
                
                <button type="submit" class="auth-btn">æ³¨å†Œ</button>
            </form>
            
            <div id="message" class="message"></div>
        </div>
    </div>
    
    <script src="{{ url_for('static', filename='js/auth.js') }}"></script>
</body>
</html>
```

#### 4.2 è®¤è¯æ ·å¼ (web/static/css/auth.css)

```css
/* è®¤è¯é¡µé¢æ ·å¼ */
.auth-container {
    display: flex;
    justify-content: center;
    align-items: center;
    min-height: 100vh;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.auth-card {
    background: white;
    border-radius: 20px;
    box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
    padding: 40px;
    width: 400px;
    max-width: 90vw;
}

.auth-header {
    text-align: center;
    margin-bottom: 30px;
}

.auth-header h1 {
    color: #333;
    margin-bottom: 10px;
    font-size: 28px;
}

.auth-header p {
    color: #666;
    font-size: 16px;
}

.auth-tabs {
    display: flex;
    margin-bottom: 30px;
    border-radius: 10px;
    background: #f5f5f5;
    padding: 5px;
}

.tab-btn {
    flex: 1;
    padding: 12px;
    border: none;
    background: transparent;
    border-radius: 8px;
    cursor: pointer;
    font-size: 16px;
    transition: all 0.3s ease;
}

.tab-btn.active {
    background: white;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    color: #667eea;
}

.auth-form {
    display: flex;
    flex-direction: column;
    gap: 20px;
}

.form-group {
    display: flex;
    flex-direction: column;
}

.form-group label {
    margin-bottom: 8px;
    color: #333;
    font-weight: 500;
}

.form-group input {
    padding: 12px 16px;
    border: 2px solid #e1e5e9;
    border-radius: 10px;
    font-size: 16px;
    transition: border-color 0.3s ease;
}

.form-group input:focus {
    outline: none;
    border-color: #667eea;
}

.auth-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 15px;
    border-radius: 10px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.3s ease;
}

.auth-btn:hover {
    transform: translateY(-2px);
}

.message {
    margin-top: 20px;
    padding: 12px;
    border-radius: 8px;
    text-align: center;
    font-weight: 500;
}

.message.success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.message.error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}
```

#### 4.3 è®¤è¯JavaScript (web/static/js/auth.js)

```javascript
// è®¤è¯é¡µé¢JavaScript
let currentTab = 'login';

function switchTab(tab) {
    currentTab = tab;
    
    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // åˆ‡æ¢è¡¨å•æ˜¾ç¤º
    if (tab === 'login') {
        document.getElementById('loginForm').style.display = 'block';
        document.getElementById('registerForm').style.display = 'none';
    } else {
        document.getElementById('loginForm').style.display = 'none';
        document.getElementById('registerForm').style.display = 'block';
    }
    
    // æ¸…é™¤æ¶ˆæ¯
    clearMessage();
}

function showMessage(message, type = 'success') {
    const messageEl = document.getElementById('message');
    messageEl.textContent = message;
    messageEl.className = `message ${type}`;
}

function clearMessage() {
    const messageEl = document.getElementById('message');
    messageEl.textContent = '';
    messageEl.className = 'message';
}

// ç™»å½•è¡¨å•å¤„ç†
document.getElementById('loginForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const data = {
        username: formData.get('username'),
        password: formData.get('password')
    };
    
    try {
        const response = await fetch('/api/auth/login', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showMessage('ç™»å½•æˆåŠŸï¼Œæ­£åœ¨è·³è½¬...', 'success');
            
            // ä¿å­˜token
            localStorage.setItem('auth_token', result.token);
            
            // è·³è½¬åˆ°ä¸»é¡µ
            setTimeout(() => {
                window.location.href = '/';
            }, 1000);
        } else {
            showMessage(result.error, 'error');
        }
    } catch (error) {
        showMessage('ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
    }
});

// æ³¨å†Œè¡¨å•å¤„ç†
document.getElementById('registerForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const password = formData.get('password');
    const confirmPassword = formData.get('confirmPassword');
    
    if (password !== confirmPassword) {
        showMessage('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´', 'error');
        return;
    }
    
    const data = {
        username: formData.get('username'),
        password: password,
        email: formData.get('email') || null
    };
    
    try {
        const response = await fetch('/api/auth/register', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showMessage('æ³¨å†ŒæˆåŠŸï¼Œæ­£åœ¨è·³è½¬...', 'success');
            
            // ä¿å­˜token
            localStorage.setItem('auth_token', result.token);
            
            // è·³è½¬åˆ°ä¸»é¡µ
            setTimeout(() => {
                window.location.href = '/';
            }, 1000);
        } else {
            showMessage(result.error, 'error');
        }
    } catch (error) {
        showMessage('æ³¨å†Œå¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
    }
});
```

### ç¬¬äº”æ­¥ï¼šä¸»åº”ç”¨é›†æˆ

#### 5.1 æ›´æ–°ä¸»åº”ç”¨ (web/app.py)

```python
import sys
import os

# æ·»åŠ çˆ¶ç›®å½•åˆ°è·¯å¾„ä»¥ä¾¿å¯¼å…¥
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from flask import Flask, render_template, request, jsonify, session, redirect, url_for
import uuid
import json
from datetime import datetime
from app.core.lightrag_engine import LightRAGEngine
from app.core.tag_extractor import TagExtractor  
from app.core.tag_manager import TagManager
from app.core.response_generator import ResponseGenerator
from app.utils.database import DatabaseManager
from app.auth.auth_manager import AuthManager
from app.auth.decorators import login_required

# å¯¼å…¥APIè“å›¾
from app.api.auth_api import auth_bp
from app.api.user_api import user_bp

app = Flask(__name__)
app.secret_key = 'lightrag_demo_secret_key'

# åˆå§‹åŒ–æ•°æ®åº“
db_manager = DatabaseManager()
app.config['DB_MANAGER'] = db_manager

# æ³¨å†Œè“å›¾
app.register_blueprint(auth_bp, url_prefix='/api/auth')
app.register_blueprint(user_bp, url_prefix='/api/user')

@app.route('/')
def index():
    """ä¸»é¡µ - æ£€æŸ¥ç™»å½•çŠ¶æ€"""
    auth_manager = AuthManager(db_manager, app.secret_key)
    current_user = auth_manager.get_current_user()
    
    if not current_user:
        return redirect(url_for('login'))
    
    return render_template('index.html', user=current_user)

@app.route('/login')
def login():
    """ç™»å½•é¡µé¢"""
    auth_manager = AuthManager(db_manager, app.secret_key)
    current_user = auth_manager.get_current_user()
    
    if current_user:
        return redirect(url_for('index'))
    
    return render_template('login.html')

@app.route('/logout')
def logout():
    """ç™»å‡º"""
    session.clear()
    return redirect(url_for('login'))

@app.route('/api/chat', methods=['POST'])
@login_required
def chat():
    """èŠå¤©æ¥å£ - éœ€è¦ç™»å½•"""
    try:
        data = request.json
        user_message = data.get('message', '')
        user_id = request.current_user["user_id"]
        
        # åˆå§‹åŒ–ç»„ä»¶
        tag_extractor = TagExtractor(str(user_id))
        tag_manager = TagManager(str(user_id))
        response_generator = ResponseGenerator(str(user_id))
        
        # æå–æ ‡ç­¾
        extracted_tags = tag_extractor.extract_tags_from_text(user_message)
        
        # æ›´æ–°æ ‡ç­¾
        updated_tags = tag_manager.update_tags(extracted_tags)
        
        # ç”Ÿæˆå›åº”
        response_data = response_generator.generate_response(user_message)
        
        return jsonify({
            "success": True,
            "response": response_data["response"],
            "user_profile": response_data["user_profile_snapshot"],
            "extracted_tags": {k: [{"name": tag.name, "confidence": tag.confidence} for tag in v] for k, v in extracted_tags.items()}
        })
        
    except Exception as e:
        return jsonify({
            "success": False,
            "error": str(e)
        }), 500

@app.route('/api/profile')
@login_required
def get_profile():
    """è·å–ç”¨æˆ·ç”»åƒ - éœ€è¦ç™»å½•"""
    try:
        user_id = request.current_user["user_id"]
        tag_manager = TagManager(str(user_id))
        user_tags = tag_manager.get_user_tags()
        
        return jsonify({
            "success": True,
            "user_tags": user_tags
        })
        
    except Exception as e:
        return jsonify({
            "success": False,
            "error": str(e)
        }), 500

@app.route('/api/add_knowledge', methods=['POST'])
@login_required
def add_knowledge():
    """æ·»åŠ çŸ¥è¯† - éœ€è¦ç™»å½•"""
    try:
        data = request.json
        knowledge_text = data.get('text', '')
        metadata = data.get('metadata', {})
        user_id = request.current_user["user_id"]
        
        lightrag = LightRAGEngine(str(user_id))
        result = lightrag.insert_knowledge(knowledge_text, metadata)
        
        return jsonify(result)
        
    except Exception as e:
        return jsonify({
            "success": False,
            "error": str(e)
        }), 500

@app.route('/api/reset_user', methods=['POST'])
@login_required
def reset_user():
    """é‡ç½®ç”¨æˆ·æ•°æ® - éœ€è¦ç™»å½•"""
    try:
        user_id = request.current_user["user_id"]
        
        # æ¸…é™¤ç”¨æˆ·æ•°æ®
        import shutil
        user_data_path = f"user_data/{user_id}"
        if os.path.exists(user_data_path):
            shutil.rmtree(user_data_path)
        
        return jsonify({
            "success": True,
            "message": "ç”¨æˆ·æ•°æ®å·²é‡ç½®"
        })
        
    except Exception as e:
        return jsonify({
            "success": False,
            "error": str(e)
        }), 500

if __name__ == '__main__':
    app.run(debug=True, port=5000)
```

### ç¬¬å…­æ­¥ï¼šé…ç½®æ–‡ä»¶æ›´æ–°

#### 6.1 æ›´æ–°é…ç½®æ–‡ä»¶ (config.yaml)

```yaml
# LightRAGæ ‡ç­¾ç³»ç»Ÿé…ç½® - ç”¨æˆ·ç³»ç»Ÿç‰ˆæœ¬
app:
  name: "LightRAG-TagSystem-Demo"
  version: "2.0.0"
  debug: true

# æ•°æ®åº“é…ç½®
database:
  type: "sqlite"
  path: "database/users.db"
  backup_enabled: true
  backup_interval_hours: 24

# è®¤è¯é…ç½®
auth:
  jwt_secret: "your-super-secret-jwt-key-change-this"
  session_timeout_hours: 24
  password_min_length: 6
  username_min_length: 3

# LLMé…ç½®
llm:
  provider: "deepseek"
  model: "deepseek-chat"
  api_key: "sk-2e4c8701d3e048b794939a432ab956ab"
  base_url: "https://api.deepseek.com"
  max_tokens: 500
  temperature: 0.7

# åµŒå…¥é…ç½®
embedding:
  provider: "deepseek"
  model: "deepseek-chat"
  base_url: "https://api.deepseek.com"
  
# å­˜å‚¨é…ç½®
storage:
  type: "local"
  base_path: "./user_data"
  backup_enabled: true
  cleanup_days: 90

# æ ‡ç­¾ç³»ç»Ÿé…ç½®
tag_system:
  dimensions:
    emotional_traits: "æƒ…æ„Ÿç‰¹å¾"
    interest_preferences: "å…´è¶£åå¥½"
    interaction_habits: "äº’åŠ¨ä¹ æƒ¯"
    value_principles: "ä»·å€¼è§‚"
  
  extraction:
    max_tags_per_dimension: 5
    confidence_threshold: 0.3
    decay_rate: 0.1
  
  weights:
    time_decay_days: 30
    usage_boost_factor: 1.2
    consistency_weight: 0.8

# Webé…ç½®
web:
  host: "127.0.0.1"
  port: 5000
  secret_key: "lightrag_demo_secret_key"
  session_timeout_hours: 24
```

### ç¬¬ä¸ƒæ­¥ï¼šä¾èµ–æ›´æ–°

#### 7.1 æ›´æ–°requirements.txt

```txt
# æ ¸å¿ƒä¾èµ–
lightrag==0.1.0b6
flask==2.3.3
openai==1.3.0
pyyaml==6.0.1
requests==2.31.0

# ç”¨æˆ·ç³»ç»Ÿæ–°å¢ä¾èµ–
pyjwt==2.8.0
cryptography==41.0.7
bcrypt==4.0.1

# æ•°æ®åº“ä¾èµ–
sqlite3  # Pythonå†…ç½®

# å¼€å‘å·¥å…·
python-dotenv==1.0.0
```

### ç¬¬å…«æ­¥ï¼šæ•°æ®åº“å·¥å…·è¡¥å……

#### 8.1 å®Œå–„æ•°æ®åº“ç®¡ç†å™¨ (app/utils/database.py)

```python
# åœ¨DatabaseManagerç±»ä¸­æ·»åŠ ä»¥ä¸‹æ–¹æ³•

def get_connection(self):
    """è·å–æ•°æ®åº“è¿æ¥"""
    return sqlite3.connect(self.db_path)

def get_user_by_id(self, user_id: int) -> Optional[Dict]:
    """æ ¹æ®IDè·å–ç”¨æˆ·"""
    try:
        with sqlite3.connect(self.db_path) as conn:
            cursor = conn.cursor()
            cursor.execute('''
                SELECT id, username, email, created_at, last_login, 
                       is_active, is_admin, profile_data, settings
                FROM users WHERE id = ?
            ''', (user_id,))
            
            result = cursor.fetchone()
            if not result:
                return None
            
            return {
                "id": result[0],
                "username": result[1],
                "email": result[2],
                "created_at": result[3],
                "last_login": result[4],
                "is_active": bool(result[5]),
                "is_admin": bool(result[6]),
                "profile_data": json.loads(result[7]) if result[7] else {},
                "settings": json.loads(result[8]) if result[8] else {}
            }
    except Exception as e:
        print(f"è·å–ç”¨æˆ·å¤±è´¥: {e}")
        return None

def update_user_profile(self, user_id: int, profile_data: Dict) -> bool:
    """æ›´æ–°ç”¨æˆ·èµ„æ–™"""
    try:
        with sqlite3.connect(self.db_path) as conn:
            cursor = conn.cursor()
            cursor.execute('''
                UPDATE users SET profile_data = ?
                WHERE id = ?
            ''', (json.dumps(profile_data), user_id))
            conn.commit()
            return True
    except Exception as e:
        print(f"æ›´æ–°ç”¨æˆ·èµ„æ–™å¤±è´¥: {e}")
        return False

def get_user_knowledge(self, user_id: int) -> List[Dict]:
    """è·å–ç”¨æˆ·çŸ¥è¯†åº“æ•°æ®"""
    try:
        with sqlite3.connect(self.db_path) as conn:
            cursor = conn.cursor()
            cursor.execute('''
                SELECT content, metadata, created_at, last_accessed, access_count
                FROM user_knowledge WHERE user_id = ?
                ORDER BY last_accessed DESC
            ''', (user_id,))
            
            results = cursor.fetchall()
            return [
                {
                    "content": row[0],
                    "metadata": json.loads(row[1]) if row[1] else {},
                    "created_at": row[2],
                    "last_accessed": row[3],
                    "access_count": row[4]
                }
                for row in results
            ]
    except Exception as e:
        print(f"è·å–ç”¨æˆ·çŸ¥è¯†åº“å¤±è´¥: {e}")
        return []

def backup_database(self) -> bool:
    """å¤‡ä»½æ•°æ®åº“"""
    try:
        import shutil
        from datetime import datetime
        
        backup_dir = "database/backups"
        os.makedirs(backup_dir, exist_ok=True)
        
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        backup_path = f"{backup_dir}/users_backup_{timestamp}.db"
        
        shutil.copy2(self.db_path, backup_path)
        return True
    except Exception as e:
        print(f"æ•°æ®åº“å¤‡ä»½å¤±è´¥: {e}")
        return False

def cleanup_expired_sessions(self) -> int:
    """æ¸…ç†è¿‡æœŸä¼šè¯"""
    try:
        with sqlite3.connect(self.db_path) as conn:
            cursor = conn.cursor()
            cursor.execute('''
                UPDATE sessions SET is_active = 0
                WHERE expires_at < CURRENT_TIMESTAMP
            ''')
            affected_rows = cursor.rowcount
            conn.commit()
            return affected_rows
    except Exception as e:
        print(f"æ¸…ç†è¿‡æœŸä¼šè¯å¤±è´¥: {e}")
        return 0
```

### ç¬¬ä¹æ­¥ï¼šå®‰å…¨å·¥å…·å®ç°

#### 9.1 åˆ›å»ºå®‰å…¨å·¥å…· (app/utils/security.py)

```python
import hashlib
import secrets
import re
from typing import Dict, List

class SecurityUtils:
    @staticmethod
    def validate_password_strength(password: str) -> Dict:
        """éªŒè¯å¯†ç å¼ºåº¦"""
        errors = []
        
        if len(password) < 8:
            errors.append("å¯†ç è‡³å°‘éœ€è¦8ä¸ªå­—ç¬¦")
        
        if not re.search(r"[a-z]", password):
            errors.append("å¯†ç éœ€è¦åŒ…å«å°å†™å­—æ¯")
        
        if not re.search(r"[A-Z]", password):
            errors.append("å¯†ç éœ€è¦åŒ…å«å¤§å†™å­—æ¯")
        
        if not re.search(r"\d", password):
            errors.append("å¯†ç éœ€è¦åŒ…å«æ•°å­—")
        
        if not re.search(r"[!@#$%^&*(),.?\":{}|<>]", password):
            errors.append("å¯†ç éœ€è¦åŒ…å«ç‰¹æ®Šå­—ç¬¦")
        
        return {
            "valid": len(errors) == 0,
            "errors": errors,
            "strength": "strong" if len(errors) == 0 else "weak"
        }
    
    @staticmethod
    def sanitize_input(text: str) -> str:
        """æ¸…ç†ç”¨æˆ·è¾“å…¥"""
        # ç§»é™¤æ½œåœ¨çš„SQLæ³¨å…¥å­—ç¬¦
        dangerous_chars = ["'", '"', ';', '--', '/*', '*/']
        for char in dangerous_chars:
            text = text.replace(char, '')
        
        # ç§»é™¤HTMLæ ‡ç­¾
        import re
        text = re.sub(r'<[^>]+>', '', text)
        
        return text.strip()
    
    @staticmethod
    def generate_secure_token(length: int = 32) -> str:
        """ç”Ÿæˆå®‰å…¨ä»¤ç‰Œ"""
        return secrets.token_urlsafe(length)
    
    @staticmethod
    def hash_password(password: str, salt: str = None) -> tuple:
        """å“ˆå¸Œå¯†ç """
        if salt is None:
            salt = secrets.token_hex(16)
        
        # ä½¿ç”¨PBKDF2è¿›è¡Œå¯†ç å“ˆå¸Œ
        import hashlib
        import hmac
        
        key = hashlib.pbkdf2_hmac(
            'sha256',
            password.encode('utf-8'),
            salt.encode('utf-8'),
            100000  # è¿­ä»£æ¬¡æ•°
        )
        
        return key.hex(), salt
    
    @staticmethod
    def verify_password(password: str, stored_hash: str, salt: str) -> bool:
        """éªŒè¯å¯†ç """
        try:
            computed_hash, _ = SecurityUtils.hash_password(password, salt)
            return hmac.compare_digest(computed_hash, stored_hash)
        except Exception:
            return False
```

### ç¬¬åæ­¥ï¼šéƒ¨ç½²å’Œæµ‹è¯•

#### 10.1 åˆ›å»ºéƒ¨ç½²è„šæœ¬ (deploy_user_system.py)

```python
#!/usr/bin/env python3
"""
ç”¨æˆ·ç³»ç»Ÿéƒ¨ç½²è„šæœ¬
"""
import os
import sys
import shutil
from pathlib import Path

def create_directories():
    """åˆ›å»ºå¿…è¦çš„ç›®å½•"""
    directories = [
        "app/models",
        "app/auth", 
        "app/api",
        "app/utils",
        "web/static/css",
        "web/static/js",
        "web/static/images",
        "database",
        "database/backups",
        "logs"
    ]
    
    for directory in directories:
        Path(directory).mkdir(parents=True, exist_ok=True)
        print(f"âœ… åˆ›å»ºç›®å½•: {directory}")

def install_dependencies():
    """å®‰è£…ä¾èµ–"""
    print("ğŸ“¦ å®‰è£…ä¾èµ–åŒ…...")
    os.system("pip install -r requirements.txt")

def setup_database():
    """è®¾ç½®æ•°æ®åº“"""
    print("ğŸ—„ï¸ åˆå§‹åŒ–æ•°æ®åº“...")
    from app.utils.database import DatabaseManager
    
    db_manager = DatabaseManager()
    print("âœ… æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ")

def create_admin_user():
    """åˆ›å»ºç®¡ç†å‘˜ç”¨æˆ·"""
    print("ğŸ‘¤ åˆ›å»ºç®¡ç†å‘˜ç”¨æˆ·...")
    from app.utils.database import DatabaseManager
    
    db_manager = DatabaseManager()
    
    # åˆ›å»ºé»˜è®¤ç®¡ç†å‘˜è´¦æˆ·
    admin_result = db_manager.create_user(
        username="admin",
        password="admin123",
        email="admin@lightrag.com"
    )
    
    if admin_result["success"]:
        print("âœ… ç®¡ç†å‘˜ç”¨æˆ·åˆ›å»ºæˆåŠŸ")
        print("   ç”¨æˆ·å: admin")
        print("   å¯†ç : admin123")
        print("   âš ï¸  è¯·åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä¿®æ”¹é»˜è®¤å¯†ç ï¼")
    else:
        print("âŒ ç®¡ç†å‘˜ç”¨æˆ·åˆ›å»ºå¤±è´¥:", admin_result["error"])

def backup_existing_data():
    """å¤‡ä»½ç°æœ‰æ•°æ®"""
    print("ğŸ’¾ å¤‡ä»½ç°æœ‰æ•°æ®...")
    
    if os.path.exists("user_data"):
        backup_dir = f"backup_{int(time.time())}"
        shutil.copytree("user_data", backup_dir)
        print(f"âœ… æ•°æ®å·²å¤‡ä»½åˆ°: {backup_dir}")

def main():
    """ä¸»éƒ¨ç½²æµç¨‹"""
    print("ğŸš€ å¼€å§‹éƒ¨ç½²LightRAGç”¨æˆ·ç³»ç»Ÿ...")
    
    # 1. åˆ›å»ºç›®å½•ç»“æ„
    create_directories()
    
    # 2. å®‰è£…ä¾èµ–
    install_dependencies()
    
    # 3. è®¾ç½®æ•°æ®åº“
    setup_database()
    
    # 4. åˆ›å»ºç®¡ç†å‘˜ç”¨æˆ·
    create_admin_user()
    
    # 5. å¤‡ä»½ç°æœ‰æ•°æ®
    backup_existing_data()
    
    print("\nğŸ‰ ç”¨æˆ·ç³»ç»Ÿéƒ¨ç½²å®Œæˆï¼")
    print("\nğŸ“‹ ä¸‹ä¸€æ­¥æ“ä½œ:")
    print("1. å¯åŠ¨åº”ç”¨: python run_demo.py")
    print("2. è®¿é—®: http://127.0.0.1:5000")
    print("3. ä½¿ç”¨ç®¡ç†å‘˜è´¦æˆ·ç™»å½•")
    print("4. æ ¹æ®éœ€è¦ä¿®æ”¹é…ç½®æ–‡ä»¶")

if __name__ == "__main__":
    main()
```

#### 10.2 åˆ›å»ºæµ‹è¯•è„šæœ¬ (test_user_system.py)

```python
#!/usr/bin/env python3
"""
ç”¨æˆ·ç³»ç»Ÿæµ‹è¯•è„šæœ¬
"""
import requests
import json
import time

class UserSystemTester:
    def __init__(self, base_url="http://127.0.0.1:5000"):
        self.base_url = base_url
        self.session = requests.Session()
    
    def test_registration(self):
        """æµ‹è¯•ç”¨æˆ·æ³¨å†Œ"""
        print("ğŸ§ª æµ‹è¯•ç”¨æˆ·æ³¨å†Œ...")
        
        data = {
            "username": "testuser",
            "password": "testpass123",
            "email": "test@example.com"
        }
        
        response = self.session.post(
            f"{self.base_url}/api/auth/register",
            json=data
        )
        
        result = response.json()
        
        if result.get("success"):
            print("âœ… æ³¨å†Œæµ‹è¯•é€šè¿‡")
            return True
        else:
            print("âŒ æ³¨å†Œæµ‹è¯•å¤±è´¥:", result.get("error"))
            return False
    
    def test_login(self):
        """æµ‹è¯•ç”¨æˆ·ç™»å½•"""
        print("ğŸ§ª æµ‹è¯•ç”¨æˆ·ç™»å½•...")
        
        data = {
            "username": "testuser",
            "password": "testpass123"
        }
        
        response = self.session.post(
            f"{self.base_url}/api/auth/login",
            json=data
        )
        
        result = response.json()
        
        if result.get("success"):
            print("âœ… ç™»å½•æµ‹è¯•é€šè¿‡")
            return True
        else:
            print("âŒ ç™»å½•æµ‹è¯•å¤±è´¥:", result.get("error"))
            return False
    
    def test_chat_functionality(self):
        """æµ‹è¯•èŠå¤©åŠŸèƒ½"""
        print("ğŸ§ª æµ‹è¯•èŠå¤©åŠŸèƒ½...")
        
        data = {
            "message": "ä½ å¥½ï¼Œæˆ‘æ˜¯ä¸€ä¸ªæµ‹è¯•ç”¨æˆ·"
        }
        
        response = self.session.post(
            f"{self.base_url}/api/chat",
            json=data
        )
        
        result = response.json()
        
        if result.get("success"):
            print("âœ… èŠå¤©åŠŸèƒ½æµ‹è¯•é€šè¿‡")
            return True
        else:
            print("âŒ èŠå¤©åŠŸèƒ½æµ‹è¯•å¤±è´¥:", result.get("error"))
            return False
    
    def test_profile_access(self):
        """æµ‹è¯•ç”¨æˆ·èµ„æ–™è®¿é—®"""
        print("ğŸ§ª æµ‹è¯•ç”¨æˆ·èµ„æ–™è®¿é—®...")
        
        response = self.session.get(f"{self.base_url}/api/auth/profile")
        
        result = response.json()
        
        if result.get("success"):
            print("âœ… ç”¨æˆ·èµ„æ–™è®¿é—®æµ‹è¯•é€šè¿‡")
            return True
        else:
            print("âŒ ç”¨æˆ·èµ„æ–™è®¿é—®æµ‹è¯•å¤±è´¥:", result.get("error"))
            return False
    
    def run_all_tests(self):
        """è¿è¡Œæ‰€æœ‰æµ‹è¯•"""
        print("ğŸš€ å¼€å§‹ç”¨æˆ·ç³»ç»Ÿæµ‹è¯•...")
        
        tests = [
            self.test_registration,
            self.test_login,
            self.test_chat_functionality,
            self.test_profile_access
        ]
        
        passed = 0
        total = len(tests)
        
        for test in tests:
            try:
                if test():
                    passed += 1
            except Exception as e:
                print(f"âŒ æµ‹è¯•å¼‚å¸¸: {e}")
        
        print(f"\nğŸ“Š æµ‹è¯•ç»“æœ: {passed}/{total} é€šè¿‡")
        
        if passed == total:
            print("ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ç”¨æˆ·ç³»ç»Ÿè¿è¡Œæ­£å¸¸ã€‚")
        else:
            print("âš ï¸  éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç³»ç»Ÿé…ç½®ã€‚")

if __name__ == "__main__":
    tester = UserSystemTester()
    tester.run_all_tests()
```

---

## ğŸ¯ å®æ–½æ€»ç»“

### æ ¸å¿ƒæ”¹è¿›ç‚¹

1. **å¤šç”¨æˆ·éš”ç¦»**: æ¯ä¸ªç”¨æˆ·æ‹¥æœ‰ç‹¬ç«‹çš„æ•°æ®ç›®å½•å’Œæ•°æ®åº“è®°å½•
2. **å®‰å…¨è®¤è¯**: JWT + SessionåŒé‡è®¤è¯æœºåˆ¶
3. **æ•°æ®æŒä¹…åŒ–**: SQLiteæ•°æ®åº“å­˜å‚¨ç”¨æˆ·ä¿¡æ¯å’Œæ ‡ç­¾æ•°æ®
4. **æƒé™ç®¡ç†**: åŸºäºè£…é¥°å™¨çš„æƒé™æ§åˆ¶ç³»ç»Ÿ
5. **å‰ç«¯ä¼˜åŒ–**: ç°ä»£åŒ–çš„ç™»å½•æ³¨å†Œç•Œé¢

### éƒ¨ç½²æ­¥éª¤

1. **ç¯å¢ƒå‡†å¤‡**: å®‰è£…Pythonä¾èµ–åŒ…
2. **æ•°æ®åº“åˆå§‹åŒ–**: è¿è¡Œéƒ¨ç½²è„šæœ¬åˆ›å»ºæ•°æ®åº“è¡¨
3. **é…ç½®æ–‡ä»¶**: æ›´æ–°config.yamlä¸­çš„ç”¨æˆ·ç³»ç»Ÿé…ç½®
4. **å¯åŠ¨åº”ç”¨**: è¿è¡ŒFlaskåº”ç”¨
5. **æµ‹è¯•éªŒè¯**: è¿è¡Œæµ‹è¯•è„šæœ¬éªŒè¯åŠŸèƒ½

### å®‰å…¨è€ƒè™‘

- å¯†ç ä½¿ç”¨PBKDF2å“ˆå¸Œå­˜å‚¨
- JWTä»¤ç‰Œè¿‡æœŸæœºåˆ¶
- è¾“å…¥æ•°æ®æ¸…ç†å’ŒéªŒè¯
- SQLæ³¨å…¥é˜²æŠ¤
- ä¼šè¯ç®¡ç†å®‰å…¨

### æ‰©å±•æ€§

- æ¨¡å—åŒ–è®¾è®¡ä¾¿äºåŠŸèƒ½æ‰©å±•
- æ”¯æŒå¤šç§è®¤è¯æ–¹å¼
- æ•°æ®åº“ç»“æ„æ”¯æŒå¤æ‚æŸ¥è¯¢
- APIè®¾è®¡éµå¾ªRESTfulè§„èŒƒ

è¿™å¥—ç”¨æˆ·ç³»ç»Ÿä¸ºLightRAGæ ‡ç­¾ç³»ç»Ÿæä¾›äº†å®Œæ•´çš„å¤šç”¨æˆ·æ”¯æŒï¼Œç¡®ä¿æ•°æ®å®‰å…¨å’Œç”¨æˆ·éš”ç¦»ï¼ŒåŒæ—¶ä¿æŒäº†è‰¯å¥½çš„æ‰©å±•æ€§å’Œç»´æŠ¤æ€§ã€‚